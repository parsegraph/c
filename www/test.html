<!DOCTYPE html>
<html>
<head>
<title>Tests - Parsegraph</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    font-family: sans-serif;
    margin: 0;
    padding: 0;
    background: #111;
    color: #eee;
}

body > div {
    width: 100%;
    margin: 1em 0;
    text-align: center;
    position: absolute;
}

.parsegraph_Graph {
    width: 500px;
    height: 500px;
}

.Successful {
    color: green;
}

.Crashed {
    color: maroon;
}

.Failed {
    color: red;
}

@media only screen and (max-width: 980px) {

body > div {
    width: 100%;
}

body > div input {
    clear: left;
}

}
</style>
<script src="parsegraph-1.0.js"></script>
<script>

function createScriptTextarea(url)
{
    var ta = document.createElement("textarea");
    ta.style.width = "400px";
    ta.style.height = "400px";
    try {
        if(ta.spellcheck) {
            ta.spellcheck = false;
        }
    }
    catch(ex) {
        // Pass
    }

    var xhr = new XMLHttpRequest();
    xhr.open("GET", url);
    xhr.addEventListener("load", function() {
        ta.appendChild(document.createTextNode(xhr.responseText));
        TA = ta;
    });
    xhr.send();

    return ta;
}

function createScriptGraph(url)
{
    var surface = new parsegraph_Surface();
    var graph = new parsegraph_Graph(surface);
    surface.resize(400, "50vh");

    var car = new parsegraph_Caret('bu');
    graph.plot(car);

    var xhr = new XMLHttpRequest();
    xhr.open("GET", url);
    xhr.addEventListener("load", function() {
        var ln = 0;
        xhr.responseText.slice(0, 100).split(/\n/).forEach(function(l) {
            if(ln % 100) {
                car.crease();
            }
            car.spawnMove('f', 'b');
            car.label(l);
            car.move('b');
            car.spawnMove('d', 'bu');
            graph.scheduleRepaint();
            ++ln;
        });
    });
    xhr.send();

    // Schedule the repaint.
    var renderTimer = new parsegraph_AnimationTimer();
    renderTimer.setListener(function() {
        graph.input().Update(new Date());
        if(graph.needsRepaint()) {
            surface.paint(50);
        }
        surface.render();
        if(graph.input().UpdateRepeatedly() || graph.needsRepaint()) {
            renderTimer.schedule();
        }
    });
    graph.input().SetListener(function(affectedPaint, eventSource, inputAffectedCamera) {
        if(affectedPaint) {
            graph.scheduleRepaint();
        }
        renderTimer.schedule();
        if(inputAffectedCamera) {
            localStorage.setItem("parsegraph_world_camera", JSON.stringify(graph.camera().toJSON()));
        }
    });
    renderTimer.schedule();
    graph.onScheduleRepaint = function() {
        renderTimer.schedule();
    };

    return surface.container();
}

document.addEventListener("DOMContentLoaded", function(event) {
    var main = document.body;

    parsegraph_initialize();

    var result = parsegraph_AllTests.run();
    result.connect(main);

    var ta = createScriptGraph("parsegraph-1.0.js");
    main.appendChild(ta);
});
</script>
</head>
<body>
</body>
</html>
