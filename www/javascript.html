<!DOCTYPE html>
<html>
<head>
<title>Parsegraph JavaScript</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    font-family: sans-serif;
    margin: 0;
    padding: 0;
}

.parsegraph_Surface {
    width: 100%;
    height: 100vh;
    margin: 0;
}

div {
    text-align: center;
    position: absolute;
}

.controls {
    margin: auto;
    position: absolute;
    pointer-events: none;
    width: 100%;
}

.controls > form button {
    pointer-events: auto;
}

@media only screen and (max-width: 980px) {

.controls {
    display: none;
}

body > div {
    width: 100%;
}

body > div input {
    clear: left;
}

}
</style>
<script src="parsegraph-1.0.js"></script>
<script src="parsegraph-examples-1.0.js"></script>
<script src="esprima.js"></script>
<script>

function parsegraph_JavaScriptWidget(graph)
{
    this.caret = new parsegraph_Caret(graph, 'b');
    this.caret.label("Program");
};

parsegraph_JavaScriptWidget.prototype.buildBody = function(ast)
{
    if(ast.body.length === 0) {
        return;
    }

    var car = this.caret;
    car.push();
    car.spawnMove('d', 'bu', 'center');
    for(var i = 0; i < ast.body.length; ++i) {
        if(i > 0) {
            car.spawnMove('f', 'bu');
        }
        car.pull('d');

        car.push();
        var child = ast.body[i];
        switch(child.type) {
        case 'FunctionDeclaration':
            car.spawnMove('d', 'b');
            car.label('function');
            car.push();
            switch(child.id.type) {
            case "Identifier":
                car.spawnMove('i', 's');
                car.label(child.id.name);
                break;
            }
            car.pop();
            car.push();
            car.spawnMove('f', 'b');
            car.spawnMove('i', 's');
            car.pop();

            this.buildBody(child);
            break;
        case 'EmptyStatement':
            car.spawnMove('d', 'bu');
            car.label(';');
            break;
        default:
            car.spawnMove('d', 'b');
            car.label(child.type);
            break;
        }
        car.pop();
    }
    car.pop();
};

parsegraph_JavaScriptWidget.prototype.load = function(url)
{
    var that = this;
    function buildTree() {
        var ast = esprima.parse(this.responseText);
        console.log(ast);

        var car = that.caret;
        car.moveToRoot();
        car.erase('f');
        car.erase('d');

        car.label(ast.type);
        car.spawnMove('i', 's');
        car.label(ast.sourceType);
        car.move('o');

        that.buildBody(ast);

        car.graph().scheduleRepaint();
    }
    var oReq = new XMLHttpRequest();
    oReq.addEventListener("load", buildTree);
    oReq.open("GET", url);
    oReq.send();
};

function init()
{
    try {
        parsegraph_initialize();
        var main = document.body;

        // Create the surface.
        var surface = new parsegraph_Surface();
        main.appendChild(surface.container());

        var graph = new parsegraph_Graph(surface);
        GRAPH = graph;

        var widget = new parsegraph_JavaScriptWidget(graph);
        widget.load("GLWidget.js");

        graph.plot(widget.caret);

        // Schedule the repaint.
        var renderTimer = new parsegraph_AnimationTimer();
        renderTimer.setListener(function() {
            if(graph.needsRepaint()) {
                surface.paint();
            }
            surface.render();
        });
        graph.input().SetListener(function(affectedPaint) {
            if(affectedPaint) {
                graph.scheduleRepaint();
            }
            renderTimer.schedule();
        });
        renderTimer.schedule();

        graph.onScheduleRepaint = function() {
            renderTimer.schedule();
        };

        // Create and add form controls.
        var controls = document.createElement("div");
        controls.className = "controls";
        main.appendChild(controls);
        controls.style.bottom = ".5em";
        var form = parsegraph_createForm();
        form.button("resetOrigin", "Reset Camera");
        form.addListener(function(sourceName, value) {
            var defaultScale = .5;
            if(sourceName == "resetOrigin") {
                graph.camera().setOrigin(
                    graph.gl().drawingBufferWidth / (2 * defaultScale),
                    graph.gl().drawingBufferHeight / (2 * defaultScale)
                );
                graph.camera().setScale(defaultScale);
            }
            else {
                return;
            }
        });
        controls.appendChild(form.asDOM());
    } catch(ex) {
        alert("Init: " + parsegraph_writeError(ex));
        throw ex;
    }
}

document.addEventListener("DOMContentLoaded", function(event) {
    init();
});
</script>
</head>
<body>
</body>
</html>
