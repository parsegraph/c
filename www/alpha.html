<!DOCTYPE html>
<html>
<head>
<title>Alpha</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>

.parsegraph_Surface {
    width: 100%;
    height: 100%;
}

body {
    font-family: sans-serif;
    margin: 0;
    padding: 0;
    background: #111;
    color: #eee;
}

body > div {
    text-align: center;
    position: absolute;
}

.Successful {
    color: green;
}

.Crashed {
    color: maroon;
}

.Failed {
    color: red;
}

@media only screen and (max-width: 980px) {

body > div {
    width: 100%;
}

body > div input {
    clear: left;
}

}
</style>
<script src="parsegraph-1.0.js"></script>
<script>

function buildPrimesDemo(graph, COUNT)
{
    if(COUNT == undefined) {
        COUNT = 50;
    }
    COUNT = Math.min(COUNT, 100);

    parsegraph_HORIZONTAL_SEPARATION_PADDING = 1;
    parsegraph_VERTICAL_SEPARATION_PADDING = 1;
    parsegraph_MIN_BLOCK_HEIGHT = parsegraph_MIN_BLOCK_WIDTH;

    function makeModulo(frequency) {
        var target = 0;

        var object = {};

        object.calculate = function(number) {
            while(number > target) {
                target += frequency;
            }
            return target - number;
        };

        object.value = function() {
            return frequency;
        };

        return object;
    };

    var knownPrimes = [];
    var candidate = 2;

    var startTime = parsegraph_getTimeInMillis();

    var caret = new parsegraph_Caret(graph, parsegraph_BLOCK);
    caret.spawnMove(parsegraph_FORWARD, parsegraph_BLOCK);
    var addBlock = function() {
        caret.spawnMove(parsegraph_FORWARD, parsegraph_BLOCK);
        caret.label(candidate);
        caret.push();
        var isPrime = true;
        for(var i = 0; i < knownPrimes.length; ++i) {
            var prime = knownPrimes[i];
            modulus = prime.calculate(candidate);
            if(modulus == 0) {
                // It's a multiple, so there's no chance for primality.
                caret.spawnMove(parsegraph_UPWARD, parsegraph_BLOCK);
                isPrime = false;
            }
            else {
                caret.spawnMove(parsegraph_UPWARD, parsegraph_SLOT);
            }
        }

        if(isPrime) {
            caret.spawnMove(parsegraph_UPWARD, parsegraph_BLOCK);
            caret.label(candidate);
            // The candidate is prime, so output it and add it to the list.
            knownPrimes.push(makeModulo(candidate));
        }

        caret.pop();
        ++candidate;
    };

    /*caret.push();
    for(var i = 0; i < knownPrimes.length; ++i) {
        caret.spawnMove(parsegraph_UPWARD, parsegraph_BLOCK);
    }
    caret.pop();*/

    //console.log(parsegraph_getTimeInMillis() - startTime);

    var scheduleAddBlock = function() {
        for(var i = 0; i < 10; ++i) {
            addBlock();
        }
        graph.surface().scheduleRepaint();
        if(knownPrimes.length > COUNT) {
            // Completed.
            return;
        }
        window.setTimeout(scheduleAddBlock, 500);
    };
    scheduleAddBlock();

    return caret;
}

document.addEventListener("DOMContentLoaded", function(event) {

parsegraph_initialize();

var surface = new parsegraph_Surface();

var widget = new alpha_GLWidget(surface);
var graph = new parsegraph_Graph(surface);

graph.plot(buildPrimesDemo(graph, 30));

var start = alpha_GetTime();

// This flag is used to squelch rendering if that function
// threw an exception and failed to complete.
var needsRender = false;
var tickIntervalId;
var tick = function() {
    // Check if a render is needed before another tick should occur.
    if(needsRender) {
        return;
    }

    // Update the scene.
    //console.log("Running tick... ");
    var t = alpha_GetTime();
    widget.Tick(t - start);
    start = t;

    // Set the render flag.
    needsRender = true;
    surface.render();
    //console.log("Tick and render complete.");
    needsRender = false;
    tickIntervalId = requestAnimationFrame(tick);
}; // Tick
tickIntervalId = requestAnimationFrame(tick);

document.body.appendChild(surface.container());

}); // DOMContentLoaded
</script>
</head>
<body>
