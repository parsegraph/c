<!DOCTYPE html>
<html>
<head>
<title>login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    font-family: sans-serif;
    margin: 0;
    padding: 0;
}

.parsegraph_Surface {
    width: 100%;
    height: 100vh;
    margin: 0;
}

div {
    text-align: center;
    position: absolute;
}

.controls {
    margin: auto;
    position: absolute;
    pointer-events: none;
    width: 100%;
}

.controls > form button {
    pointer-events: auto;
}

@media only screen and (max-width: 980px) {

.controls {
    display: none;
}

body > div {
    width: 100%;
}

body > div input {
    clear: left;
}

}
</style>
<script src="parsegraph-1.2.js"></script>
<script src="parsegraph-widgets-1.2.js"></script>
<script src="esprima.js"></script>
<script>

function parsegraph_List_new(name, callback, callbackThisArg)
{
    var xhr = new XMLHttpRequest();
    xhr.open('POST', "/list?command=parsegraph_List_new", true);
    xhr.setRequestHeader('Accept', 'application/json');
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = function() {
        if(xhr.readyState === 4) {
            if(callback) {
                callback.call(callbackThisArg || xhr, JSON.parse(xhr.response));
            }
        }
    };
    xhr.send("name="+encodeURIComponent(name));
    return xhr;
}

function parsegraph_List_appendItem(listId, typeId, value, callback, callbackThisArg)
{
    var xhr = new XMLHttpRequest();
    xhr.open('POST', "/list?command=parsegraph_List_appendItem", true);
    xhr.setRequestHeader('Accept', 'application/json');
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = function() {
        if(xhr.readyState === 4) {
            if(callback) {
                console.log(xhr.response);
                callback.call(callbackThisArg || xhr, JSON.parse(xhr.response));
            }
        }
    };
    xhr.send("list_id="+encodeURIComponent(listId) + "&type=" + encodeURIComponent(typeId) + "&value=" + encodeURIComponent(value));
    return xhr;
}

function parsegraph_List_prependItem(listId, typeId, value, callback, callbackThisArg)
{
    var xhr = new XMLHttpRequest();
    xhr.open('POST', "/list?command=parsegraph_List_prependItem", true);
    xhr.setRequestHeader('Accept', 'application/json');
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = function() {
        if(xhr.readyState === 4) {
            if(callback) {
                console.log(xhr.response);
                callback.call(callbackThisArg || xhr, JSON.parse(xhr.response));
            }
        }
    };
    xhr.send("list_id="+encodeURIComponent(listId) + "&type=" + encodeURIComponent(typeId) + "&value=" + encodeURIComponent(value));
    return xhr;
}

function init(main)
{
    try {
        parsegraph_initialize();
        var surface = new parsegraph_Surface();
        var graph = new parsegraph_Graph(surface);
        GRAPH = graph;
        var uni = new parsegraph_Unicode();
        uni.onLoad = function() {
            graph.setGlyphAtlas(parsegraph_buildGlyphAtlas());
            graph.glyphAtlas().setUnicode(uni);

            main.appendChild(surface.container());
            var widget = new parsegraph_LoginWidget(surface, graph);
            graph.world().plot(widget.root());
            widget.authenticate();

            var profile;
            var cameraProtocol;

            widget.setLoginListener(function(res, userLogin, node) {
                //console.log(userLogin, node);

                if(!profile) {
                    profile = new parsegraph_ProfileWidget(graph);
                    profile.load(userLogin.username);
                    node.connectNode(parsegraph_DOWNWARD, profile.node());
                    profile.setLoadListener(function() {
                        graph.scheduleRepaint();
                    }, this);
                }

                if(!cameraProtocol) {
                    cameraProtocol = new parsegraph_CameraProtocol(new WebSocket(
                        "ws://localhost/camera/", "parsegraph-camera-protocol"
                    ), graph.camera(),
                        function(obj) {
                            //console.log(obj);
                            graph.cameraBox().setCamera(userLogin.username, obj);
                        }
                    );
                }

                parsegraph_List_new(userLogin.username, function(response) {
                    if(response.id) {

                    }

                    var initial = profile.node().spawnNode(parsegraph_DOWNWARD, parsegraph_BUD);
                    profile.node().setNodeAlignmentMode(parsegraph_DOWNWARD, parsegraph_ALIGN_CENTER);

                    var len = 0;
                    var budClickListener;
                    budClickListener = function() {
                        if(this.hasNode(parsegraph_DOWNWARD)) {
                            return;
                        }
                        value = "NOTIME" + len;
                        if(!this.hasNode(parsegraph_FORWARD)) {
                            parsegraph_List_appendItem(response.id, 0, value, function() {
                                var b = this.spawnNode(parsegraph_DOWNWARD, parsegraph_BLOCK);
                                b.setLabel(value, graph.glyphAtlas());
                                b.realLabel().setEditable(true);
                                this.setLayoutPreference(parsegraph_PREFER_VERTICAL_AXIS);
                                var n = this.spawnNode(parsegraph_FORWARD, parsegraph_BUD);
                                n.setClickListener(budClickListener, n);
                                if(!this.hasNode(parsegraph_BACKWARD)) {
                                    var p = this.spawnNode(parsegraph_BACKWARD, parsegraph_BUD);
                                    p.setClickListener(budClickListener, p);
                                }
                                graph.scheduleRepaint();
                            }, this);
                        }
                        else if(!this.hasNode(parsegraph_BACKWARD)) {
                            parsegraph_List_prependItem(response.id, 0, value, function() {
                                var b = this.spawnNode(parsegraph_DOWNWARD, parsegraph_BLOCK);
                                b.setLabel(value, graph.glyphAtlas());
                                b.realLabel().setEditable(true);
                                this.setLayoutPreference(parsegraph_PREFER_VERTICAL_AXIS);
                                var n = this.spawnNode(parsegraph_BACKWARD, parsegraph_BUD);
                                n.setClickListener(budClickListener, n);
                                graph.scheduleRepaint();
                            }, this);
                        }
                        ++len;
                    };
                    initial.setClickListener(budClickListener);
                }, this);
            });
            widget.setLogoutListener(function(res, userLogin, node) {
                node.disconnectNode(parsegraph_DOWNWARD);
            });

            var cameraName = "parsegraph_login_camera";
            if(localStorage.getItem(cameraName) != null) {
                try {
                    var cameraData = JSON.parse(localStorage.getItem(cameraName));
                    graph.camera().restore(cameraData);
                } catch(e) {
                    console.log(
                        "Failed to parse saved camera state.\n" + parsegraph_writeError(e)
                    );
                }
            }

            // Schedule the repaint.
            var renderTimer = new parsegraph_AnimationTimer();
            var start = alpha_GetTime();
            renderTimer.setListener(function() {
                graph.input().Update(new Date());
                var t = alpha_GetTime();
                start = t;
                if(graph.needsRepaint()) {
                    surface.paint(50);
                }
                surface.render();
                if(graph.input().UpdateRepeatedly() || graph.needsRepaint()) {
                    if(cameraProtocol && graph.input().UpdateRepeatedly()) {
                        cameraProtocol.update();
                    }
                    renderTimer.schedule();
                }
            });
            graph.input().SetListener(function(affectedPaint, eventSource, inputAffectedCamera) {
                if(affectedPaint) {
                    graph.scheduleRepaint();
                }
                renderTimer.schedule();
                if(inputAffectedCamera) {
                    if(cameraProtocol) {
                        cameraProtocol.update();
                    }
                    localStorage.setItem(cameraName, JSON.stringify(graph.camera().toJSON()));
                }
            });
            renderTimer.schedule();
            graph.onScheduleRepaint = function() {
                renderTimer.schedule();
            };
            };
        uni.load();
        parsegraph_UNICODE_INSTANCE = uni;
    } catch(ex) {
        alert("Init: " + parsegraph_writeError(ex));
        throw ex;
    }
}

document.addEventListener("DOMContentLoaded", function(event) {
    init(document.body);
});
</script>
</head>
<body>
</body>
</html>
